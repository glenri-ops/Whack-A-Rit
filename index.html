<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Whack-A-Rit</title>
  <style>
    html,body{margin:0;height:100%;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto;-webkit-tap-highlight-color:transparent;overscroll-behavior:none}
    body{touch-action:manipulation}
    #app{position:relative;width:100%;height:100%;overflow:hidden;background:#000}

    /* Background: crop, don't stretch */
    #bgImg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;z-index:0;user-select:none;-webkit-user-drag:none}

    /* Table centered */
    #table{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(94vw,900px);height:auto;opacity:0;transition:opacity .2s;
      z-index:1;user-select:none;-webkit-user-drag:none
    }

    /* HUD: hidden until Play */
    #hud{position:absolute;left:16px;right:16px;top:12px;display:none;gap:12px;z-index:5}
    .pill{
      background:#00c853;color:#fff;border:1px solid rgba(255,255,255,.18);
      border-radius:12px;padding:10px 14px;box-shadow:0 6px 18px rgba(0,0,0,.25);
      font-weight:900
    }

    /* Start overlay */
    #overlay{
      position:absolute;inset:0;display:flex;flex-direction:column;gap:10px;
      align-items:center;justify-content:center;z-index:20;background:rgba(0,0,0,0.06)
    }
    #play{
      background:#00c853;border:0;color:#fff;border-radius:18px;padding:18px 40px;
      font-size:22px;font-weight:900;box-shadow:0 10px 26px rgba(0,0,0,.35)
    }
    #play:active{transform:translateY(1px)}
    #status{color:rgba(255,255,255,.92);font-weight:900;text-align:center;max-width:520px;line-height:1.25}
    #status small{display:block;color:rgba(255,255,255,.65);font-weight:800;margin-top:6px}

    /* Targets */
    .hole{position:absolute;width:96px;height:96px;border-radius:50%;overflow:visible;pointer-events:auto;z-index:6}
    .target{
      position:absolute;left:0;right:0;margin:auto;bottom:-44px;width:96px;height:96px;border-radius:50%;
      background:#111;border:1px solid rgba(255,255,255,.2);
      display:flex;align-items:center;justify-content:center;
      opacity:0;transform:scale(.92);
      transition:transform .14s ease-out, opacity .08s ease-out, bottom .14s ease-out;
      pointer-events:auto
    }
    .target img{width:92px;height:92px;border-radius:50%;user-select:none;-webkit-user-drag:none}
    .target.show{opacity:1;transform:scale(1);bottom:0}
    .ring{position:absolute;inset:-6px;border-radius:50%;border:2px solid rgba(255,255,255,.28);pointer-events:none}
  </style>
</head>
<body>
<div id="app">
  <!-- IMPORTANT: these 4 images must be in the repo ROOT -->
  <img id="bgImg" src="./bg.png" alt="bg" draggable="false"/>
  <img id="table" src="./table.png" alt="table" draggable="false"/>

  <div id="hud">
    <div class="pill">Score: <span id="score">0</span></div>
  </div>

  <div id="overlay">
    <button id="play" type="button" disabled>Loadingâ€¦</button>
    <div id="status">Loading imagesâ€¦<small>Files required in repo root: bg.png, table.png, good.png, bad.png</small></div>
  </div>
</div>

<script>
(() => {
  // ===== FILES (repo root) =====
  const BG_SRC    = "./bg.png";
  const TABLE_SRC = "./table.png";
  const GOOD_SRC  = "./good.png"; // hitting GOOD => GAME OVER (instant)
  const BAD_SRC   = "./bad.png";  // hitting BAD  => +1 point

  // ===== GAME FEEL =====
  const visibleMs = 950;     // how long a target stays up
  const spawnMin  = 850;     // min time between spawns
  const spawnMax  = 1400;    // max time between spawns
  const goodChance = 0.25;   // chance the GOOD appears

  // Hole centers in TABLE coordinates (x: left->right, y: bottom->top)
  const holes = [
    {x:.20,y:.63},{x:.50,y:.64},{x:.80,y:.63},
    {x:.20,y:.40},{x:.50,y:.40},{x:.80,y:.40}
  ];

  // ===== STATE =====
  let score = 0;
  let running = false;
  let active = null;         // { holeEl, targetEl, isGood }
  let missTimer = null;
  let spawnTimer = null;

  // ===== DOM =====
  const table   = document.getElementById("table");
  const scoreEl = document.getElementById("score");
  const hud     = document.getElementById("hud");
  const overlay = document.getElementById("overlay");
  const playBtn = document.getElementById("play");
  const status  = document.getElementById("status");

  // Avoid iOS gesture/scroll stealing taps
  document.addEventListener("gesturestart", e => e.preventDefault());
  document.addEventListener("touchmove", e => e.preventDefault(), {passive:false});

  // ===== HELPERS =====
  function updateHUD(){
    scoreEl.textContent = String(score);
  }

  function clearTimers(){
    if(missTimer){ clearTimeout(missTimer); missTimer = null; }
    if(spawnTimer){ clearTimeout(spawnTimer); spawnTimer = null; }
  }

  function cleanupActive(){
    if(!active) return;
    active.targetEl.classList.remove("show");
    const h = active.holeEl;
    setTimeout(() => h.remove(), 140);
    active = null;
  }

  function endGame(reasonText){
    running = false;
    clearTimers();
    cleanupActive();

    table.style.opacity = 0;
    hud.style.display = "none";
    overlay.style.display = "flex";
    playBtn.disabled = false;
    playBtn.textContent = "Play";
    status.innerHTML = (reasonText || "Game over.") + "<small>Tap Play to restart.</small>";

    // Alert for clarity (you can remove later)
    alert("Game Over");
  }

  function holePixel(i){
    const r = table.getBoundingClientRect();
    return {
      x: r.left + holes[i].x * r.width,
      y: r.top  + (1 - holes[i].y) * r.height
    };
  }

  function spawn(){
    if(!running) return;

    // If a target is still active when the next spawn is scheduled, just despawn it (NO game over)
    if(active){
      cleanupActive();
    }

    const r = table.getBoundingClientRect();
    // Guard: wait until table has a real layout size
    if(r.width < 60 || r.height < 60){
      spawnTimer = setTimeout(spawn, 150);
      return;
    }

    const idx = Math.floor(Math.random() * holes.length);
    const isGood = Math.random() < goodChance;
    const p = holePixel(idx);

    const holeEl = document.createElement("div");
    holeEl.className = "hole";
    holeEl.style.left = (p.x - 48) + "px";
    holeEl.style.top  = (p.y - 48) + "px";

    const targetEl = document.createElement("div");
    targetEl.className = "target";
    targetEl.innerHTML = '<div class="ring"></div><img src="' + (isGood ? GOOD_SRC : BAD_SRC) + '" />';

    const onTap = (e) => {
      e.preventDefault();
      e.stopPropagation();
      if(!running || !active) return;

      clearTimeout(missTimer);
      missTimer = null;

      if(active.isGood){
        // âœ… YOUR RULE: ONLY lose if you hit GOOD
        endGame("You hit the GOOD one ðŸ˜¬");
        return;
      }

      // âœ… YOUR RULE: hit BAD => +1 point
      score += 1;
      updateHUD();
      cleanupActive();
    };

    // iPhone-safe touch handlers
    targetEl.addEventListener("touchstart", onTap, {passive:false});
    targetEl.addEventListener("touchend", onTap, {passive:false});
    targetEl.addEventListener("pointerdown", onTap);
    targetEl.addEventListener("click", onTap);

    holeEl.appendChild(targetEl);
    document.body.appendChild(holeEl);

    active = { holeEl, targetEl, isGood };

    requestAnimationFrame(() => targetEl.classList.add("show"));

    // If you don't tap in time: just remove it (NO game over)
    missTimer = setTimeout(() => {
      cleanupActive();
    }, visibleMs);

    // Schedule next spawn
    const delay = Math.floor(spawnMin + Math.random() * (spawnMax - spawnMin));
    spawnTimer = setTimeout(spawn, delay);
  }

  function startGame(){
    score = 0;
    running = true;

    clearTimers();
    cleanupActive();

    updateHUD();
    hud.style.display = "flex";
    table.style.opacity = 1;
    overlay.style.display = "none";

    // Delay to stabilize layout
    setTimeout(spawn, 220);
  }

  // ===== PRELOAD (prevents broken icons, enables Play only when ready) =====
  const assets = [
    {name:"bg.png",    src:BG_SRC},
    {name:"table.png", src:TABLE_SRC},
    {name:"good.png",  src:GOOD_SRC},
    {name:"bad.png",   src:BAD_SRC},
  ];

  function preloadAll(){
    let done = 0;
    const failed = [];
    return new Promise((resolve) => {
      assets.forEach(a => {
        const img = new Image();
        img.onload = () => { done++; if(done + failed.length === assets.length) resolve({failed}); };
        img.onerror = () => { failed.push(a.name); if(done + failed.length === assets.length) resolve({failed}); };
        img.src = a.src + "?v=" + Date.now(); // cache-bust GitHub Pages
      });
    });
  }

  preloadAll().then(({failed}) => {
    if(failed.length){
      playBtn.disabled = true;
      playBtn.textContent = "Fix files";
      status.innerHTML =
        "Images failed to load:<br><b>" + failed.join(", ") + "</b>" +
        "<small>Confirm these exact file names exist in repo root.</small>";
      return;
    }
    playBtn.disabled = false;
    playBtn.textContent = "Play";
    status.innerHTML = "Ready.<small>Hit BAD for points. If you hit GOOD: instant game over.</small>";
  });

  // Start: button + overlay tap
  const startTap = (e) => {
    e.preventDefault();
    e.stopPropagation();
    if(!playBtn.disabled) startGame();
  };
  playBtn.addEventListener("click", startTap);
  playBtn.addEventListener("pointerdown", startTap);
  playBtn.addEventListener("touchend", startTap, {passive:false});
  overlay.addEventListener("click", startTap);
  overlay.addEventListener("pointerdown", startTap);
  overlay.addEventListener("touchend", startTap, {passive:false});

  window.addEventListener("resize", () => { if(active) cleanupActive(); });

})();
</script>
</body>
</html>
